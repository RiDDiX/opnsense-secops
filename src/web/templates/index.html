<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPNsense Security Auditor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-shield-halved"></i>
            <span>SecAudit</span>
        </div>
        <ul class="sidebar-nav">
            <li class="nav-item active" data-view="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </li>
            <li class="nav-item" data-view="findings">
                <i class="fas fa-bug"></i>
                <span>Findings</span>
            </li>
            <li class="nav-item" data-view="firewall">
                <i class="fas fa-fire"></i>
                <span>Firewall</span>
            </li>
            <li class="nav-item" data-view="dns">
                <i class="fas fa-globe"></i>
                <span>DNS</span>
            </li>
            <li class="nav-item" data-view="system">
                <i class="fas fa-server"></i>
                <span>System</span>
            </li>
            <li class="nav-item" data-view="network">
                <i class="fas fa-laptop"></i>
                <span>Netzwerk</span>
            </li>
            <li class="nav-item" data-view="config">
                <i class="fas fa-cog"></i>
                <span>Konfiguration</span>
            </li>
        </ul>
        <div class="sidebar-footer">
            <div class="connection-status" id="connection-status">
                <span class="status-dot offline"></span>
                <span>Nicht verbunden</span>
            </div>
            <a href="https://www.paypal.me/RiDDiX93" target="_blank" rel="noopener" class="donate-link">
                <i class="fas fa-heart"></i>
                <span>Support</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="main-header">
            <div class="header-left">
                <h1 id="view-title">Security Dashboard</h1>
                <span class="header-subtitle" id="opnsense-host">--</span>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" id="btn-start-scan">
                    <i class="fas fa-play"></i>
                    <span>Scan starten</span>
                </button>
                <button class="btn btn-ghost" id="btn-download-report" title="Report herunterladen" style="display:none">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-ghost" id="btn-refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>

        <!-- Live Scan Panel (hidden by default) -->
        <div class="scan-panel hidden" id="scan-panel">
            <div class="scan-header">
                <div class="scan-title">
                    <i class="fas fa-radar fa-spin"></i>
                    <span>Security Scan läuft...</span>
                </div>
                <button class="btn btn-sm btn-danger" id="btn-cancel-scan">
                    <i class="fas fa-stop"></i> Abbrechen
                </button>
            </div>
            <div class="scan-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="scan-progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="scan-progress-text">0%</span>
            </div>
            <div class="scan-details">
                <div class="scan-current-check" id="scan-current-check">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>Initialisiere...</span>
                </div>
                <div class="scan-stats">
                    <div class="stat"><span id="stat-rules-checked">0</span> Regeln</div>
                    <div class="stat"><span id="stat-findings">0</span> Findings</div>
                    <div class="stat"><span id="stat-duration">0s</span></div>
                </div>
            </div>
            <div class="scan-log" id="scan-log">
                <div class="log-entry info">
                    <span class="log-time">--:--:--</span>
                    <span class="log-msg">Warte auf Start...</span>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div class="view active" id="view-dashboard">
            <!-- Score Section -->
            <section class="score-section">
                <div class="score-card main-score">
                    <div class="score-ring" id="score-ring">
                        <svg viewBox="0 0 100 100">
                            <circle class="score-bg" cx="50" cy="50" r="45"/>
                            <circle class="score-fg" cx="50" cy="50" r="45" id="score-circle"/>
                        </svg>
                        <div class="score-value">
                            <span id="security-score">--</span>
                            <small>/100</small>
                        </div>
                    </div>
                    <div class="score-info">
                        <span class="score-grade" id="security-grade">--</span>
                        <span class="score-label">Security Score</span>
                    </div>
                </div>
                <div class="score-breakdown">
                    <div class="breakdown-item">
                        <span class="breakdown-label">Firewall</span>
                        <div class="breakdown-bar"><div class="fill" id="score-firewall" style="width:0%"></div></div>
                        <span class="breakdown-value" id="score-firewall-val">--</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">DNS</span>
                        <div class="breakdown-bar"><div class="fill" id="score-dns" style="width:0%"></div></div>
                        <span class="breakdown-value" id="score-dns-val">--</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">System</span>
                        <div class="breakdown-bar"><div class="fill" id="score-system" style="width:0%"></div></div>
                        <span class="breakdown-value" id="score-system-val">--</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">VPN</span>
                        <div class="breakdown-bar"><div class="fill" id="score-vpn" style="width:0%"></div></div>
                        <span class="breakdown-value" id="score-vpn-val">--</span>
                    </div>
                </div>
            </section>

            <!-- Severity Summary -->
            <section class="severity-summary">
                <div class="severity-card critical">
                    <div class="severity-icon"><i class="fas fa-skull-crossbones"></i></div>
                    <div class="severity-data">
                        <span class="severity-count" id="count-critical">0</span>
                        <span class="severity-label">Critical</span>
                    </div>
                </div>
                <div class="severity-card high">
                    <div class="severity-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="severity-data">
                        <span class="severity-count" id="count-high">0</span>
                        <span class="severity-label">High</span>
                    </div>
                </div>
                <div class="severity-card medium">
                    <div class="severity-icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="severity-data">
                        <span class="severity-count" id="count-medium">0</span>
                        <span class="severity-label">Medium</span>
                    </div>
                </div>
                <div class="severity-card low">
                    <div class="severity-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="severity-data">
                        <span class="severity-count" id="count-low">0</span>
                        <span class="severity-label">Low</span>
                    </div>
                </div>
            </section>

            <!-- Quick Stats -->
            <section class="quick-stats">
                <div class="stat-card">
                    <i class="fas fa-shield-alt"></i>
                    <div class="stat-data">
                        <span class="stat-value" id="stat-fw-rules">--</span>
                        <span class="stat-label">Firewall Regeln</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-random"></i>
                    <div class="stat-data">
                        <span class="stat-value" id="stat-nat-rules">--</span>
                        <span class="stat-label">NAT Regeln</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-network-wired"></i>
                    <div class="stat-data">
                        <span class="stat-value" id="stat-interfaces">--</span>
                        <span class="stat-label">Interfaces</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <div class="stat-data">
                        <span class="stat-value" id="stat-last-scan">--</span>
                        <span class="stat-label">Letzter Scan</span>
                    </div>
                </div>
            </section>

            <!-- Top Findings -->
            <section class="top-findings">
                <div class="section-header">
                    <h2><i class="fas fa-exclamation-triangle"></i> Kritische Findings</h2>
                    <a href="#" class="link" data-view="findings">Alle anzeigen →</a>
                </div>
                <div class="findings-list" id="top-findings-list">
                    <div class="no-data">
                        <i class="fas fa-check-circle"></i>
                        <p>Starte einen Scan um Findings zu sehen</p>
                    </div>
                </div>
            </section>

            <!-- Scan History / Trend -->
            <section class="scan-history" id="scan-history-section" style="display:none">
                <div class="section-header" style="display:flex;justify-content:space-between;align-items:center">
                    <h2><i class="fas fa-chart-line"></i> Scan-Verlauf</h2>
                    <button class="btn btn-sm btn-danger" id="btn-clear-history" title="Alle Reports löschen">
                        <i class="fas fa-trash"></i> Verlauf löschen
                    </button>
                </div>
                <div class="history-chart" id="history-chart">
                    <div class="no-data">
                        <i class="fas fa-chart-line"></i>
                        <p>Mindestens 2 Scans für Trend-Anzeige nötig</p>
                    </div>
                </div>
                <div class="history-table" id="history-table"></div>
            </section>
        </div>

        <!-- Findings View -->
        <div class="view" id="view-findings">
            <div class="view-header">
                <div class="filter-bar">
                    <select id="filter-severity" class="filter-select">
                        <option value="all">Alle Schweregrade</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <select id="filter-category" class="filter-select">
                        <option value="all">Alle Kategorien</option>
                        <option value="firewall">Firewall</option>
                        <option value="dns">DNS</option>
                        <option value="system">System</option>
                        <option value="vpn">VPN</option>
                        <option value="vlan">VLAN</option>
                        <option value="vulnerability">Vulnerabilities</option>
                    </select>
                    <input type="search" id="filter-search" class="filter-search" placeholder="Suchen...">
                </div>
            </div>
            <div class="findings-container" id="all-findings-list">
                <div class="no-data">
                    <i class="fas fa-search"></i>
                    <p>Keine Findings vorhanden</p>
                </div>
            </div>
        </div>

        <!-- Firewall View -->
        <div class="view" id="view-firewall">
            <div class="view-header">
                <h2>Firewall Regelanalyse</h2>
            </div>
            <div class="rules-analysis">
                <div class="analysis-summary" id="fw-analysis-summary">
                    <div class="summary-item">
                        <span class="label">Analysierte Regeln:</span>
                        <span class="value" id="fw-total-rules">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Problematische Regeln:</span>
                        <span class="value warning" id="fw-problem-rules">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Any-to-Any Regeln:</span>
                        <span class="value danger" id="fw-any-rules">--</span>
                    </div>
                </div>
                <div class="rules-list" id="fw-rules-list">
                    <div class="no-data">
                        <i class="fas fa-fire"></i>
                        <p>Firewall Regeln werden nach Scan angezeigt</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DNS View -->
        <div class="view" id="view-dns">
            <div class="view-header">
                <h2>DNS Konfiguration</h2>
            </div>
            <div class="dns-analysis">
                <div class="dns-status-cards" id="dns-status-cards">
                    <div class="status-card">
                        <div class="status-icon"><i class="fas fa-shield-alt"></i></div>
                        <div class="status-info">
                            <span class="status-label">DNSSEC</span>
                            <span class="status-value" id="dns-dnssec">--</span>
                        </div>
                    </div>
                    <div class="status-card">
                        <div class="status-icon"><i class="fas fa-lock"></i></div>
                        <div class="status-info">
                            <span class="status-label">DNS over TLS</span>
                            <span class="status-value" id="dns-dot">--</span>
                        </div>
                    </div>
                    <div class="status-card">
                        <div class="status-icon"><i class="fas fa-ban"></i></div>
                        <div class="status-info">
                            <span class="status-label">Rebinding Schutz</span>
                            <span class="status-value" id="dns-rebind">--</span>
                        </div>
                    </div>
                </div>
                <div class="dns-servers" id="dns-servers-list">
                    <h3>Konfigurierte DNS Server</h3>
                    <div class="server-list">
                        <div class="no-data">
                            <i class="fas fa-globe"></i>
                            <p>DNS Server werden nach Scan angezeigt</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Devices View -->
        <div class="view" id="view-network">
            <div class="view-header">
                <h2>Netzwerk-Geräte</h2>
                <div class="header-actions">
                    <input type="search" id="device-search" class="filter-search" placeholder="IP, Hostname, MAC suchen...">
                </div>
            </div>
            <div class="device-stats" id="device-stats">
                <div class="stat-card">
                    <i class="fas fa-laptop"></i>
                    <div class="stat-data">
                        <span class="stat-value" id="stat-total-devices">--</span>
                        <span class="stat-label">Geräte</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-door-open"></i>
                    <div class="stat-data">
                        <span class="stat-value" id="stat-total-open-ports">--</span>
                        <span class="stat-label">Offene Ports</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-network-wired"></i>
                    <div class="stat-data">
                        <span class="stat-value" id="stat-total-networks">--</span>
                        <span class="stat-label">Netzwerke</span>
                    </div>
                </div>
            </div>
            <div class="devices-table-container">
                <table class="devices-table" id="devices-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>IP-Adresse</th>
                            <th>Hostname</th>
                            <th>MAC-Adresse</th>
                            <th>Netzwerk</th>
                            <th>Offene Ports</th>
                        </tr>
                    </thead>
                    <tbody id="devices-tbody">
                        <tr><td colspan="6" class="no-data-cell">Starte einen Netzwerk-Scan um Geräte zu sehen</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- System View -->
        <div class="view" id="view-system">
            <div class="view-header">
                <h2>System Sicherheit</h2>
            </div>
            <div class="system-analysis">
                <div class="system-checks" id="system-checks">
                    <div class="no-data">
                        <i class="fas fa-server"></i>
                        <p>System-Checks werden nach Scan angezeigt</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Config View -->
        <div class="view" id="view-config">
            <div class="view-header">
                <h2>OPNsense Verbindung</h2>
            </div>
            <div class="config-form">
                <div class="form-section">
                    <h3><i class="fas fa-plug"></i> API Verbindung</h3>
                    <div class="form-group">
                        <label for="cfg-host">OPNsense Host</label>
                        <input type="text" id="cfg-host" placeholder="192.168.1.1 oder opnsense.local">
                        <span class="form-hint">IP-Adresse oder Hostname der OPNsense</span>
                    </div>
                    <div class="form-group">
                        <label for="cfg-apikey">API Key</label>
                        <input type="text" id="cfg-apikey" placeholder="API Key aus OPNsense">
                        <span class="form-hint">System → Access → Users → API Keys</span>
                    </div>
                    <div class="form-group">
                        <label for="cfg-apisecret">API Secret</label>
                        <input type="password" id="cfg-apisecret" placeholder="API Secret">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" id="btn-test-connection">
                            <i class="fas fa-plug"></i> Verbindung testen
                        </button>
                        <button class="btn btn-success" id="btn-save-config">
                            <i class="fas fa-save"></i> Speichern
                        </button>
                    </div>
                    <div class="connection-result hidden" id="connection-result"></div>
                </div>
                <div class="form-section" style="margin-top:24px">
                    <h3><i class="fas fa-clock"></i> Automatischer Scan-Schedule</h3>
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="schedule-enabled">
                            <span>Automatische Scans aktivieren</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="schedule-interval">Intervall (Stunden)</label>
                        <select id="schedule-interval" class="filter-select">
                            <option value="1">Jede Stunde</option>
                            <option value="6">Alle 6 Stunden</option>
                            <option value="12">Alle 12 Stunden</option>
                            <option value="24" selected>Täglich (24h)</option>
                            <option value="48">Alle 2 Tage</option>
                            <option value="168">Wöchentlich</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nächster Scan</label>
                        <span id="schedule-next-run" style="color:var(--text-muted)">Nicht geplant</span>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" id="btn-save-schedule">
                            <i class="fas fa-save"></i> Schedule speichern
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Finding Detail Modal -->
    <div class="modal hidden" id="finding-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Finding Details</h3>
                <button class="modal-close" id="modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-sm btn-ghost" id="btn-exclude-finding" title="Finding zur Ausnahmeliste hinzufügen">
                    <i class="fas fa-eye-slash"></i> Ausschließen
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
