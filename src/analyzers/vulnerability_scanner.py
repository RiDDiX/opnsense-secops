"""
Vulnerability Scanner
Checks for known CVEs and security vulnerabilities using external APIs
"""
import logging
import requests
from typing import Dict, List, Set
from dataclasses import dataclass
from datetime import datetime, timedelta
import json

logger = logging.getLogger(__name__)


@dataclass
class VulnerabilityFinding:
    """Represents a vulnerability finding"""
    severity: str
    cve_id: str
    title: str
    description: str
    affected_service: str
    affected_version: str
    cvss_score: float
    published_date: str
    solution: str
    references: List[str]


class VulnerabilityScanner:
    """Scans for known vulnerabilities using CVE databases"""

    def __init__(self, scan_options: Dict):
        self.scan_options = scan_options
        self.cache = {}
        self.cache_timeout = timedelta(hours=24)

    def scan_services(self, discovered_services: Dict[str, Dict]) -> List[VulnerabilityFinding]:
        """
        Scan discovered services for known vulnerabilities

        Args:
            discovered_services: Dict mapping host:port to service info
                e.g., {"192.168.1.100:22": {"name": "ssh", "version": "OpenSSH 7.4"}}
        """
        findings = []

        for endpoint, service_info in discovered_services.items():
            service_name = service_info.get("name", "").lower()
            version = service_info.get("version", "")

            if not service_name or not version:
                continue

            logger.info(f"Checking vulnerabilities for {service_name} {version} on {endpoint}")

            # Check multiple vulnerability databases
            vulns = []
            vulns.extend(self._check_nvd(service_name, version))
            vulns.extend(self._check_cve_search(service_name, version))
            vulns.extend(self._check_vulners(service_name, version))

            for vuln in vulns:
                vuln.affected_service = f"{endpoint} ({service_name})"
                vuln.affected_version = version
                findings.append(vuln)

        return findings

    def _check_nvd(self, service: str, version: str) -> List[VulnerabilityFinding]:
        """Check National Vulnerability Database (NVD)"""
        findings = []

        try:
            # NVD API 2.0
            url = "https://services.nvd.nist.gov/rest/json/cves/2.0"

            # Search for service name
            params = {
                "keywordSearch": f"{service} {version}",
                "resultsPerPage": 20
            }

            response = requests.get(url, params=params, timeout=10)

            if response.status_code == 200:
                data = response.json()

                for item in data.get("vulnerabilities", []):
                    cve = item.get("cve", {})
                    cve_id = cve.get("id", "")

                    # Extract CVSS score
                    cvss_score = 0.0
                    severity = "UNKNOWN"

                    metrics = cve.get("metrics", {})
                    if "cvssMetricV31" in metrics:
                        cvss_data = metrics["cvssMetricV31"][0]["cvssData"]
                        cvss_score = cvss_data.get("baseScore", 0.0)
                        severity = self._cvss_to_severity(cvss_score)

                    # Extract description
                    descriptions = cve.get("descriptions", [])
                    description = ""
                    for desc in descriptions:
                        if desc.get("lang") == "en":
                            description = desc.get("value", "")
                            break

                    # Extract references
                    references = []
                    for ref in cve.get("references", [])[:3]:
                        references.append(ref.get("url", ""))

                    # Published date
                    published = cve.get("published", "")

                    findings.append(VulnerabilityFinding(
                        severity=severity,
                        cve_id=cve_id,
                        title=f"CVE in {service}",
                        description=description[:500],
                        affected_service="",
                        affected_version="",
                        cvss_score=cvss_score,
                        published_date=published,
                        solution=self._generate_solution(service, cve_id),
                        references=references
                    ))

        except Exception as e:
            logger.debug(f"NVD check failed: {e}")

        return findings

    def _check_cve_search(self, service: str, version: str) -> List[VulnerabilityFinding]:
        """Check CVE circl.lu API"""
        findings = []

        try:
            # circl.lu CVE search
            url = f"https://cve.circl.lu/api/search/{service}/{version}"

            response = requests.get(url, timeout=10)

            if response.status_code == 200:
                data = response.json()

                for item in data[:10]:  # Limit to 10 results
                    cve_id = item.get("id", "")
                    cvss = float(item.get("cvss", 0.0))
                    severity = self._cvss_to_severity(cvss)

                    summary = item.get("summary", "")
                    published = item.get("Published", "")

                    references = []
                    if "references" in item:
                        references = item["references"][:3]

                    findings.append(VulnerabilityFinding(
                        severity=severity,
                        cve_id=cve_id,
                        title=f"Known vulnerability in {service}",
                        description=summary[:500],
                        affected_service="",
                        affected_version="",
                        cvss_score=cvss,
                        published_date=published,
                        solution=self._generate_solution(service, cve_id),
                        references=references
                    ))

        except Exception as e:
            logger.debug(f"CVE search failed: {e}")

        return findings

    def _check_vulners(self, service: str, version: str) -> List[VulnerabilityFinding]:
        """Check Vulners.com API (requires API key for full access)"""
        findings = []

        # Vulners API is rate-limited without key
        # This is a basic implementation
        try:
            url = "https://vulners.com/api/v3/search/lucene/"

            query = f"{service} {version}"

            payload = {
                "query": query,
                "limit": 10
            }

            response = requests.post(url, json=payload, timeout=10)

            if response.status_code == 200:
                data = response.json()

                if data.get("result") == "OK":
                    for item in data.get("data", {}).get("search", [])[:5]:
                        vuln_data = item.get("_source", {})

                        cve_id = vuln_data.get("cvelist", [""])[0] if vuln_data.get("cvelist") else "N/A"
                        cvss = float(vuln_data.get("cvss", {}).get("score", 0.0))
                        severity = self._cvss_to_severity(cvss)

                        description = vuln_data.get("description", "")
                        published = vuln_data.get("published", "")

                        findings.append(VulnerabilityFinding(
                            severity=severity,
                            cve_id=cve_id,
                            title=f"Vulnerability in {service}",
                            description=description[:500],
                            affected_service="",
                            affected_version="",
                            cvss_score=cvss,
                            published_date=published,
                            solution=self._generate_solution(service, cve_id),
                            references=[f"https://vulners.com/cve/{cve_id}"]
                        ))

        except Exception as e:
            logger.debug(f"Vulners check failed: {e}")

        return findings

    def check_opnsense_version(self, version: str) -> List[VulnerabilityFinding]:
        """Check for known OPNsense vulnerabilities"""
        findings = []

        try:
            # Check OPNsense changelog/security advisories
            url = "https://docs.opnsense.org/security.html"

            # This is a simplified version - in production you'd parse the security page
            # or use a dedicated API

            logger.info(f"Checking OPNsense {version} for known vulnerabilities")

            # For now, we'll check CVE databases for OPNsense
            findings.extend(self._check_nvd("opnsense", version))

        except Exception as e:
            logger.error(f"OPNsense version check failed: {e}")

        return findings

    def check_critical_services(self, services: List[Dict]) -> List[VulnerabilityFinding]:
        """Check if critical services have known exploits"""
        findings = []

        # List of services with frequently discovered vulnerabilities
        critical_services = {
            "ssh": "OpenSSH",
            "apache": "Apache HTTP Server",
            "nginx": "Nginx",
            "mysql": "MySQL",
            "postgresql": "PostgreSQL",
            "redis": "Redis",
            "docker": "Docker",
            "elasticsearch": "Elasticsearch"
        }

        for service in services:
            service_name = service.get("name", "").lower()

            if service_name in critical_services:
                logger.info(f"Checking critical service: {service_name}")

                # Check for recent critical CVEs
                recent_vulns = self._get_recent_cves(critical_services[service_name])
                findings.extend(recent_vulns)

        return findings

    def _get_recent_cves(self, product: str, days: int = 90) -> List[VulnerabilityFinding]:
        """Get CVEs published in the last N days for a product"""
        findings = []

        try:
            # Calculate date range
            end_date = datetime.now()
            start_date = end_date - timedelta(days=days)

            url = "https://services.nvd.nist.gov/rest/json/cves/2.0"

            params = {
                "keywordSearch": product,
                "pubStartDate": start_date.strftime("%Y-%m-%dT00:00:00.000"),
                "pubEndDate": end_date.strftime("%Y-%m-%dT23:59:59.999"),
                "resultsPerPage": 10
            }

            response = requests.get(url, params=params, timeout=10)

            if response.status_code == 200:
                data = response.json()

                for item in data.get("vulnerabilities", []):
                    cve = item.get("cve", {})
                    cve_id = cve.get("id", "")

                    # Extract CVSS
                    cvss_score = 0.0
                    severity = "UNKNOWN"

                    metrics = cve.get("metrics", {})
                    if "cvssMetricV31" in metrics and metrics["cvssMetricV31"]:
                        cvss_data = metrics["cvssMetricV31"][0]["cvssData"]
                        cvss_score = cvss_data.get("baseScore", 0.0)
                        severity = self._cvss_to_severity(cvss_score)

                    # Only include high/critical
                    if cvss_score >= 7.0:
                        descriptions = cve.get("descriptions", [])
                        description = ""
                        for desc in descriptions:
                            if desc.get("lang") == "en":
                                description = desc.get("value", "")
                                break

                        references = []
                        for ref in cve.get("references", [])[:3]:
                            references.append(ref.get("url", ""))

                        published = cve.get("published", "")

                        findings.append(VulnerabilityFinding(
                            severity=severity,
                            cve_id=cve_id,
                            title=f"Recent CVE in {product}",
                            description=description[:500],
                            affected_service=product,
                            affected_version="Check installed version",
                            cvss_score=cvss_score,
                            published_date=published,
                            solution=f"Update {product} to latest version. Check vendor security advisories.",
                            references=references
                        ))

        except Exception as e:
            logger.debug(f"Recent CVEs check failed: {e}")

        return findings

    def _cvss_to_severity(self, cvss: float) -> str:
        """Convert CVSS score to severity level"""
        if cvss >= 9.0:
            return "CRITICAL"
        elif cvss >= 7.0:
            return "HIGH"
        elif cvss >= 4.0:
            return "MEDIUM"
        else:
            return "LOW"

    def _generate_solution(self, service: str, cve_id: str) -> str:
        """Generate solution text based on service and CVE"""
        solutions = {
            "ssh": f"Update SSH server to latest version. Check {cve_id} details for specific patch level.",
            "apache": f"Update Apache to latest version. Review {cve_id} for configuration changes.",
            "nginx": f"Update Nginx to latest version. See {cve_id} for security patch details.",
            "mysql": f"Update MySQL/MariaDB to latest version. Consult {cve_id} advisory.",
            "postgresql": f"Update PostgreSQL to latest version. Review {cve_id} release notes.",
            "opnsense": f"Update OPNsense via System > Firmware > Updates. Review {cve_id} security advisory."
        }

        for key, solution in solutions.items():
            if key in service.lower():
                return solution

        return f"Update {service} to latest version and review {cve_id} for specific mitigation steps."

    def get_vulnerability_summary(self, findings: List[VulnerabilityFinding]) -> Dict:
        """Generate summary statistics"""
        return {
            "total_vulnerabilities": len(findings),
            "critical": len([f for f in findings if f.severity == "CRITICAL"]),
            "high": len([f for f in findings if f.severity == "HIGH"]),
            "medium": len([f for f in findings if f.severity == "MEDIUM"]),
            "low": len([f for f in findings if f.severity == "LOW"]),
            "unique_cves": len(set(f.cve_id for f in findings if f.cve_id != "N/A")),
            "average_cvss": sum(f.cvss_score for f in findings) / len(findings) if findings else 0.0
        }
